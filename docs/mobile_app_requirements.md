# Speakr 移动端与流式 ASR 前期需求

## 1. 背景与目标
- 构建一个基于 Flutter 的移动端客户端，覆盖日常录音、回看、检索等使用场景，现有 Web 端继续承担管理与高级配置职能。
- 引入基于 `faster-whisper` 的流式语音识别通道，实现比批处理更低延迟的实时字幕，同时保留全量离线转录的精度。
- 方案需延续 Speakr 的自托管特性，满足隐私与合规要求，并支持后续商业化变现能力。

## 2. 项目范围
- **纳入范围：** 原生体验的移动端录音与播放、实时字幕、标签管理、AI 查询、流式 ASR 网关、移动友好型 API 及认证改造、订阅计费体验。
- **阶段划分：** 第一阶段聚焦 iOS 客户端，完成 Apple 登录、应用内购订阅与核心录音链路；之后再评估 Android 端与多平台支付方案。
- **MVP 暂不包含：** 复杂的后台配置、批量导出/批量管理、高级模板编辑、多租户管理等功能，仍在 Web 管理端完成。

## 3. 目标用户与关键旅程
- **个人录音者：** 手机快速录制会议/采访 → 实时看到字幕 → 标记重点 → 事后查看摘要。
- **移动办公成员：** 在外搜索历史录音、阅读摘要、向 AI 提问，无需回到桌面端。
- **审核/协作者：** 收到分享通知 → 打开移动端 → 阅读已确认的转录与摘要 → 视需要下载或评论。

关键旅程示例：
1. 打开 App → 生物识别解锁 → 选择 Apple / Google / 邮箱登录 → 一键录音 → 实时字幕滚动 → 停止 → 批处理完成后推送最终转录+摘要。
2. 浏览最近录音（优先加载离线缓存） → 按标签/日期过滤 → 播放 → 编辑说话人或高亮。
3. 调用 Inquire 搜索跨录音内容 → 取得引用与出处 → 分享片段或导出事件到日历。
4. 查看剩余免费分钟数 → 达到 300 分钟后提示订阅 → 在 iOS 内通过应用内购完成按月订阅并解锁无限使用。

## 4. 功能需求
### 4.1 认证与账户
- 支持邮箱+密码登录（Token 制：Access/Refresh），可选生物识别解锁。
- 支持 Google OAuth 登录；在 iOS 端提供 Apple Sign-In；多种方式可互相绑定同一账户。
- 记录设备列表、远程登出、重置密码。

### 4.2 录音与实时转录
- 高质量录音，支持暂停/继续、麦克风权限管理、后台保活。
- 双通道转录：
  1. **流式字幕：** 每 320–500 ms 发送 Opus 音频块，经 WebSocket 推送到 faster-whisper，界面展示临时与 `is_final` 句子。
  2. **离线终稿：** 停止录音后，将完整音频上传至现有 `/upload`，后端执行高精度批处理转录与摘要。
- 异常处理：断网时本地缓存音频并重试块上传；离线模式跳过流式字幕但保留最终上传。
- 界面需显示缓冲、置信度、延迟等状态（目标端到端延迟 <1.5 s）。

### 4.3 录音库
- 基于 `/api/recordings` 的分页列表，缓存最近 N 条并在后台同步。
- 筛选项：标签、日期、搜索关键词、状态。
- 详情页展示：波形/播放、最终转录、实时字幕日志、摘要、说话人标签、事件列表、AI 聊天记录。
- 可执行操作：重命名、标签管理、收藏/标记、说话人重标、删除（离线需二次确认）。

### 4.4 AI 交互
- 录音内对话：调用 `/chat`，保留本地会话历史并显示引用。
- 跨录音 Inquire：通过 `/api/inquire/search`、`/api/inquire/chat` 提问，发送前可设置标签/日期过滤。

### 4.5 分享与协作
- 创建与管理分享链接（`/api/recording/{id}/share`、`/api/shares`），支持复制、修改过期时间、撤销。
- 通过深链查看收到的分享，必要时提示登录。

### 4.6 事件与日历
- 展示录音中提取的事件（`/api/recording/{id}/events`），支持导出 ICS 并调用系统分享。
- 预留与系统日历打通的扩展能力。

### 4.7 设置与偏好
- 语言切换（同步 i18n）、转录默认参数（语言/说话人范围）、主题、缓存上限、通知开关。
- 诊断页显示 ASR 网关状态、App 版本、后端版本等信息。

### 4.8 订阅与用量
- 所有账户每月享受 300 分钟免费转录额度（实时+离线合并计算），展示剩余额度与重置倒计时。
- 免费额度用尽后，引导用户在 iOS 内通过应用内购订阅月度套餐，订阅后解锁更高或不限用量；后续阶段再扩展至其他平台支付方案。
- 支持查看历史账单与订阅状态；若订阅失效，自动回退到免费额度策略。
- 后端需提供分钟统计 API、订阅状态同步、超限阻断策略、Grace Period 提醒。

## 5. 非功能需求
- **性能：** 冷启动 <2 秒；实时字幕延迟 <1.5 秒；30 分钟音频的离线转录在 2 分钟内完成。
- **可靠性：** 音频块上传需重试策略，ASR WebSocket 断线指数退避；流式服务不可用时优雅降级；订阅状态更新需保证一致性。
- **安全：** 全链路 TLS；JWT 存储在系统安全空间（Keychain/加密存储）；本地缓存加密，登出清除；第三方登录令牌安全续期；遵循 Apple 应用内购安全规范。
- **隐私合规：** 遵循现有保留策略，提供删除与导出请求入口，默认不开启第三方遥测；支付/订阅数据需满足 App Store 合规与当地法规要求。
- **无障碍：** 动态字体、实时字幕的屏幕阅读标注、高对比度主题。

## 6. 架构概述
1. 移动端（Flutter）负责界面、`drift`/`Hive` 等本地缓存、`record`/`flutter_sound` 录音插件、后台上传、APNs 推送、Apple IAP SDK 集成（后续再扩展 Android/FCM）。
2. 基于 `faster-whisper` 的流式 ASR 网关提供 WebSocket 接口：
   - 会话建立（如 `POST /ws/session` 握手，返回会话 ID + 授权令牌）。
   - 音频块上传（二进制 Opus/PCM，携带递增序号与时间戳）。
   - 增量转录事件 `{ type: "partial" | "final", text, start, end, confidence }`。
   - 与计费服务交互，按会话累计实时消耗分钟数。
3. 现有 Flask 后端继续作为数据主系统：
   - 新增移动端 JWT 接口（如 `/api/mobile/login`），支持 OAuth 登录态同步。
   - 接收 `/upload` 提交的完整音频，调用批处理转录/摘要。
   - 通过 Webhook→推送任务在完成时通知客户端，并写入用量统计。
   - 订阅计费模块负责配额计算、套餐定义、账单处理与 iOS IAP 凭证校验。
4. 可选的消息队列/流（Redis Streams 或 RabbitMQ）用于缓冲音频块和转录事件，为多 ASR 工作线程扩容；同时时间序列数据库或缓存（Redis/Timescale）记录分钟用量。

实时数据流：
`Flutter 麦克风 → 分块编码 → WS → faster-whisper Worker → 部分/最终字幕 → WS → Flutter UI`

终稿数据流：
`Flutter 上传 → Flask /upload → 后台任务 → 数据库更新 → 推送通知 → Flutter 同步`

计费数据流：
`WS/上传会话 → 用量统计服务 → 额度判断/扣减 → IAP 状态校验 → 返回额度信息给客户端`

## 7. 技术选型与理由
| 组件 | 选型 | 理由 |
|------|------|------|
| 移动框架 | Flutter | 跨平台一致性，长期规划包含 Android；现阶段优先 iOS。 |
| 音频采集 | `record` / `flutter_sound` | 支持原始 PCM/Opus，兼容后台录音，iOS 适配成熟。 |
| 网络通信 | REST 用 `dio`，WebSocket 用 `web_socket_channel`/`stomp_dart_client` | 拥有稳健的重试机制与二进制传输能力。 |
| 第三方登录 | `google_sign_in`、`sign_in_with_apple` | 官方/主流插件，满足合规要求，支持账号绑定。 |
| 内购/订阅 | `in_app_purchase`（优先 iOS） | 与 Apple StoreKit 对接，支持订阅生命周期，后续可扩展至其他平台。 |
| 本地存储 | `drift` 或 `Hive` | 便于离线优先，支持加密存储。 |
| 流式 ASR | `faster-whisper` (CTranslate2) | CPU/GPU 推理速度快，社区活跃，有现成流式适配。 |
| 容器化 | Docker + 可选 CUDA | 与既有部署方式保持一致，易于扩展 GPU。 |
| 消息中间件 | Redis Streams（优先） | 轻量化，便于管理流式任务。 |
| 推送 | APNs（第一阶段） | 面向 iOS 用户推送批处理完成通知。 |
| 支付后台 | App Store Server API / 自建订阅服务 | 校验 iOS 订阅收据、同步订阅状态；后续可扩展 Stripe 等方案。 |

## 8. 后端改造清单
- 实现移动端认证接口（发放/刷新/吊销 JWT），补充 CORS、设备信息记录，并接入 Google/Apple OAuth 登录。
- 为 ASR 网关提供鉴权机制（短期签名令牌或会话票据），并在数据库登记会话用于审计和分钟统计。
- 扩展 `/upload` 流程，将实时会话 ID 与最终转录关联（便于差分与回溯），同步扣减用量。
- 增加用于推送的后台任务/队列，处理转录成功、失败等状态通知。
- 订阅计费模块：
  - 记录每个账户的月度剩余额度、订阅级别、续费状态。
  - 对接 Apple In-App Purchase：支持订阅创建、续订、过期、退款、免受限制期；使用 App Store Server API 校验收据。
  - 提供查询/提醒 API 给移动端。
- 在管理后台提供 ASR 网关与计费配置界面，包括地址、分块参数、超时、GPU 状态、套餐价格、免费额度。

## 9. 未决问题与风险
- ASR Worker 部署硬件：只用 CPU 还是需要 GPU？并发目标是多少？直接影响延迟预算。
- Whisper 是否需要替换或补充其他模型（如 `distil-large-v2`），是否需要语言定制或多语言回退策略？
- 实时字幕草稿是否落库？若持久化需评估合规与存储成本。
- iOS 应用内购的审核与上架流程（合规文案、隐私政策、订阅页面），以及自托管环境如何同步订阅状态。
- 后续若扩展 Android/其他支付，需要重新评估价格策略与收益分成。
- iOS 后台录音限制是否需要额外权限或业务降级策略。

## 10. 下一步建议
1. 确认基础设施约束（GPU、Redis、推送、Apple 开发者账号、IAP 审核）并敲定 ASR 与计费部署拓扑。
2. 本地搭建 faster-whisper 流式服务原型，验证分块大小、延迟、终稿比对与分钟扣减策略。
3. 输出涵盖认证、录音、标签、AI、订阅的移动端 API 合同（OpenAPI），列清 OAuth 与 IAP 回调接口。
4. 制作 iOS 端优先的 Flutter 线框与状态管理方案（如 Riverpod/Bloc），设计离线缓存与订阅提示逻辑。
5. 拆分里程碑：
   - Alpha：录音+实时字幕+免费额度统计（iOS）。
    - Beta：录音库+AI 功能+Apple/Google 登录整合（iOS）。
    - Release：iOS 应用内购订阅、推送、体验打磨与 App Store 上架准备；并规划 Android 版本的可行性评估。

